<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data</title>
    <!-- Bootstrap & ApexCharts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/home.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>

    <!-- Header and Navigation -->
    <header class="main-header position-relative">
        <div class="header-content container-fluid h-100">
            <div class="logo-container position-absolute top-50 start-50 translate-middle">
                <img src="../images/rakusens_logo.svg" alt="Rakusens Logo" class="logo-svg">
            </div>
        </div>
    </header>

    <nav class="main-nav navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid justify-content-center">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="../home.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="historical.html">Historical Data</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="help.html">Help & Support</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Sensor Data Section -->
    <div class="container my-5 text-center">
        <h2 class="mb-4" id="sensorTitle">Loading...</h2>

        <!-- First Graph: Line Chart -->
        <div class="chart-container">
            <h3>Temperature Over Time</h3>
            <div id="sensorChart" style="height: 400px;"></div>
        </div>

        <!-- Temperature Display -->
        <h3 class="mt-3">Current Temperature:</h3>
        <h1 id="temperatureDisplay" class="text-primary fw-bold">-- °C</h1>

        <!-- Statistics Section -->
        <div class="row mt-4">
            <div class="col-md-4">
                <h4>Mean Temperature</h4>
                <h2 id="meanTemperature">-- °C</h2>
            </div>
            <div class="col-md-4">
                <h4>Minimum Temperature</h4>
                <h2 id="minTemperature">-- °C</h2>
            </div>
            <div class="col-md-4">
                <h4>Maximum Temperature</h4>
                <h2 id="maxTemperature">-- °C</h2>
            </div>
        </div>

        <!-- Second Graph: Scatter Plot -->
        <div class="chart-container mt-5">
            <h3>Temperature Data (Scatter Plot)</h3>
            <div id="sensorScatterChart" style="height: 400px;"></div>
        </div>

        <!-- Third Graph: Area Chart -->
        <div class="chart-container mt-5">
            <h3>Temperature Trend (Area Chart)</h3>
            <div id="sensorAreaChart" style="height: 400px;"></div>
        </div>
    </div>

    <script>
        // Extract sensor and line from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sensor = urlParams.get("sensor");
        const line = urlParams.get("line");

        // Update page title
        document.getElementById("sensorTitle").textContent = `Sensor Data for ${sensor} on ${line}`;

        // Store last 50 readings
        let temperatureData = [];

        // Define line chart options
        const lineChartOptions = {
            chart: { type: "line", height: 400, animations: { enabled: false } },
            series: [{ name: sensor, data: [] }],
            xaxis: { type: "datetime", labels: { format: "HH:mm:ss" } },
            yaxis: { title: { text: "Temperature (°C)" } }
        };

        // Define scatter plot options
        const scatterChartOptions = {
            chart: { type: "scatter", height: 400, animations: { enabled: false } },
            series: [{ name: sensor, data: [] }],
            xaxis: { type: "datetime", labels: { format: "HH:mm:ss" } },
            yaxis: { title: { text: "Temperature (°C)" } },
            markers: { size: 5, colors: ["#FF4560"] }
        };

        // Define area chart options
        const areaChartOptions = {
            chart: { type: "area", height: 400, animations: { enabled: false } },
            series: [{ name: sensor, data: [] }],
            xaxis: { type: "datetime", labels: { format: "HH:mm:ss" } },
            yaxis: { title: { text: "Temperature (°C)" } },
            fill: {
                type: "gradient",
                gradient: { shadeIntensity: 0.5, opacityFrom: 0.6, opacityTo: 0.2, stops: [0, 90, 100] }
            }
        };

        // Render the charts
        const sensorChart = new ApexCharts(document.getElementById("sensorChart"), lineChartOptions);
        const sensorScatterChart = new ApexCharts(document.getElementById("sensorScatterChart"), scatterChartOptions);
        const sensorAreaChart = new ApexCharts(document.getElementById("sensorAreaChart"), areaChartOptions);

        sensorChart.render();
        sensorScatterChart.render();
        sensorAreaChart.render();

        // Function to fetch and update the charts with real data
        function fetchSensorData() {
            if (!line || !sensor) {
                console.error("Line or sensor missing from URL");
                return;
            }

            fetch(`http://127.0.0.1:5000/api/live-data/${line}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data[sensor]) {
                        let newTemperature = data.data[sensor]; // Get temperature value
                        let timestamp = new Date().getTime();
                        let newData = { x: timestamp, y: newTemperature };

                        // Update the temperature display
                        document.getElementById("temperatureDisplay").textContent = `${newTemperature.toFixed(1)} °C`;

                        // Store temperature data (only keep last 50 readings)
                        temperatureData.push(newTemperature);
                        if (temperatureData.length > 50) temperatureData.shift();

                        // Calculate statistics
                        let mean = (temperatureData.reduce((a, b) => a + b, 0) / temperatureData.length).toFixed(1);
                        let min = Math.min(...temperatureData).toFixed(1);
                        let max = Math.max(...temperatureData).toFixed(1);

                        // Update the statistics display
                        document.getElementById("meanTemperature").textContent = `${mean} °C`;
                        document.getElementById("minTemperature").textContent = `${min} °C`;
                        document.getElementById("maxTemperature").textContent = `${max} °C`;

                        // Update charts with new data
                        sensorChart.updateSeries([{ name: sensor, data: [...sensorChart.w.config.series[0].data, newData].slice(-50) }]);
                        sensorScatterChart.updateSeries([{ name: sensor, data: [...sensorScatterChart.w.config.series[0].data, newData].slice(-50) }]);
                        sensorAreaChart.updateSeries([{ name: sensor, data: [...sensorAreaChart.w.config.series[0].data, newData].slice(-50) }]);
                    }
                })
                .catch(error => console.error("API Error:", error));
        }

        // Fetch data every 5 seconds
        setInterval(fetchSensorData, 5000);
    </script>

</body>

</html>