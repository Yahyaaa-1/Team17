<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sensor Data</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link rel="stylesheet" href="../css/home.css"/>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <div class="container my-5 text-center">
    <h2 class="mb-4" id="sensorTitle">Loading...</h2>

    <!-- Line Chart -->
    <div class="chart-container mb-4">
      <h3>Temperature Over Time</h3>
      <div id="sensorChart" style="height: 400px;"></div>
    </div>

    <h3 class="mt-3">Current Temperature:</h3>
    <h1 id="temperatureDisplay" class="text-primary fw-bold">-- °C</h1>

    <!-- Statistics -->
    <div class="row mt-4">
      <div class="col-md-4"><h4>Mean</h4><h2 id="meanTemperature">-- °C</h2></div>
      <div class="col-md-4"><h4>Min</h4><h2 id="minTemperature">-- °C</h2></div>
      <div class="col-md-4"><h4>Max</h4><h2 id="maxTemperature">-- °C</h2></div>
    </div>

    <!-- Scatter Chart -->
    <div class="chart-container mt-5">
      <h3>Temperature Scatter</h3>
      <div id="sensorScatterChart" style="height: 400px;"></div>
    </div>

    <!-- Area Chart -->
    <div class="chart-container mt-5">
      <h3>Temperature Trend (Area)</h3>
      <div id="sensorAreaChart" style="height: 400px;"></div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const line = urlParams.get("line") || "line4";
    const sensor = urlParams.get("sensor") || "r01";
    const cacheKey = `sensorData_${line}_${sensor}`;
    let chartData = [];
    let temperatureData = [];

    document.getElementById("sensorTitle").textContent = `Sensor Data for ${sensor} on ${line}`;

    const baseChartOptions = {
      chart: { animations: { enabled: false }, height: 400, toolbar: { show: false } },
      series: [{ name: sensor, data: [] }],
      xaxis: {
        type: "datetime",
        title: { text: "Time" },
        labels: {
          datetimeFormatter: {
            hour: "HH:mm",
            minute: "HH:mm",
            second: "HH:mm:ss"
          }
        },
        tooltip: { enabled: true },
        range: 2 * 60 * 60 * 1000 // 2 hours
      },
      yaxis: { title: { text: "Temperature (°C)" } }
    };

    const sensorChart = new ApexCharts(document.querySelector("#sensorChart"), {
      ...baseChartOptions,
      chart: { ...baseChartOptions.chart, type: "line" }
    });

    const sensorScatterChart = new ApexCharts(document.querySelector("#sensorScatterChart"), {
      ...baseChartOptions,
      chart: { ...baseChartOptions.chart, type: "scatter" },
      markers: { size: 5, colors: ["#FF4560"] }
    });

    const sensorAreaChart = new ApexCharts(document.querySelector("#sensorAreaChart"), {
      ...baseChartOptions,
      chart: { ...baseChartOptions.chart, type: "area" },
      fill: {
        type: "gradient",
        gradient: { shadeIntensity: 0.5, opacityFrom: 0.6, opacityTo: 0.2, stops: [0, 90, 100] }
      }
    });

    sensorChart.render();
    sensorScatterChart.render();
    sensorAreaChart.render();

    function loadInitialData() {
      const cached = JSON.parse(localStorage.getItem(cacheKey) || "[]");
      const now = Date.now();
      const twoHoursAgo = now - 2 * 60 * 60 * 1000;

      chartData = cached.filter(p => p.x >= twoHoursAgo).sort((a, b) => a.x - b.x);
      temperatureData = chartData.map(p => p.y);

      updateCharts(chartData);
      updateStatistics();

      setInterval(fetchLiveData, 8000);
    }

    function fetchLiveData() {
      fetch(`http://localhost:5000/api/live-data/${line}`)
        .then(res => res.json())
        .then(data => {
          if (data.success && data.data[sensor]) {
            const now = Date.now();
            const point = { x: now, y: parseFloat(data.data[sensor]) };

            chartData.push(point);
            chartData = chartData.filter(p => p.x >= now - 2 * 60 * 60 * 1000);
            temperatureData = chartData.map(p => p.y);

            updateCharts(chartData);
            updateStatistics();
            localStorage.setItem(cacheKey, JSON.stringify(chartData));
          }
        })
        .catch(err => console.error("Live update error:", err));
    }

    function updateCharts(data) {
      const updatedSeries = [{ name: sensor, data }];
      sensorChart.updateSeries(updatedSeries);
      sensorScatterChart.updateSeries(updatedSeries);
      sensorAreaChart.updateSeries(updatedSeries);
    }

    function updateStatistics() {
      if (!temperatureData.length) return;
      const mean = (temperatureData.reduce((a, b) => a + b, 0) / temperatureData.length).toFixed(1);
      const min = Math.min(...temperatureData).toFixed(1);
      const max = Math.max(...temperatureData).toFixed(1);
      const latest = temperatureData[temperatureData.length - 1].toFixed(1);

      document.getElementById("temperatureDisplay").textContent = `${latest} °C`;
      document.getElementById("meanTemperature").textContent = `${mean} °C`;
      document.getElementById("minTemperature").textContent = `${min} °C`;
      document.getElementById("maxTemperature").textContent = `${max} °C`;
    }

    loadInitialData();
  </script>
</body>
</html>
